#!/bin/bash

AMI="$0"

while [ -h "$AMI" ]; do
  ls=$(ls -ld "$AMI")
  link=$(expr "$ls" : '.*-> \(.*\)$')
  if expr "$link" : '/.*' > /dev/null; then
    AMI="$link"
  else
    AMI=$(dirname "$AMI")/"$link"
  fi
done

# etched in the stone...
export AMI
export AMI_PROG=$(basename "$0")
export AMI_MDIR=$(dirname "$AMI")

# load config
AMI_CONF="$AMI_MDIR/etc/ami"
[ -f "$AMI_CONF" ] && . "$AMI_CONF" "$AMI_CONF" || { echo "$AMI_PROG: no $AMI_CONF config file found" >&2; exit 1; }

# load library
AMI_LIBF="$AMI_MDIR/lib/ami"
[ -f "$AMI_LIBF" ] && . "$AMI_LIBF" "$AMI_LIBF" || { echo "$AMI_PROG: no $AMI_LIBF lib file found" >&2; exit 1; }

# DEBUG(for now)
export AMI_DBG=${AMI_DBG:-1}
settings
export -f settings

export AMI_CWD=$(pwd)
# not sure about that...
[ -n "$AMI_ROOT" ] && {
	cd "$AMI_ROOT" || die 1 "cd $AMI_ROOT failure" ;
	} || {
	die 1 "AMI_ROOT not set" ;
	}

# bail if nothing to do...
[ $# -eq 0 ] && usage

# main()
[ $AMI_DBG -eq 1 ] && echo "## cmd: '$1' ##"
case $1 in
	cmds)
		cmds ;;
	init)
		shift
		runcmd init $* ;;
	*)
		runcmd init
		runcmd "$@" ;;
esac

[ $AMI_DBG -eq 1 ] && {
	echo "## ar<$@>gs ##" ;
	echo "## pw<$(pwd)>d ##" ;
} || true
