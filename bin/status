#!/bin/bash

load etc ami
load etc init # svn...

function status_ami() {
	local agitd="$AMI_MDIR/.git"
	[ -d "$agitd" ] && {
		local cmd="git status -sbu";
		echo "# $AMI_PROG status ami -> $cmd";
		GIT_DIR="$agitd" GIT_WORK_TREE="$AMI_MDIR" $cmd;
	}
}

function status_svn() {
	local d="$AMI_SVND"
	local p=${1:-*}
	shift
	# we should prolly be both smarter here and in regards to $p since it may be "unpresent"
	# TOFIX: but for now this shall dooo... eh, not really, bah.
	local reps=${@:-$SVN_REPOS}
	# TODO: if p!* check in which repo queried pkg is...
	[ -d "$d" ] && echo "# $AMI_PROG status svn $p"
	for r in $reps; do
		[ -d "$d/$r/.svn" ] && {
			( cd $d && {
				echo "# svn status -u $r/$p";
				# hmm... "$r/"$p or... hmmm
				svn status -u "$r/$p";
				# no sense in doing anything if nothing exists
				ls "$r/"$p"/trunk/PKGBUILD" 1>/dev/null 2>&1 && {
					# argh... need opts like in git... anywayz. --depth dirs only?
					echo "# svn status -v $r/$p/trunk/PKGBUILD";
					svn status -v "$r/"$p"/trunk/PKGBUILD";
				}
			} )
		}
	done
}

function status_git() {
	[ -z "$1" ] && {
		local tagopts="-l";
		local bchopts="-C 10 ^\*";
		local clropts=always;
	} || {
		local tagopts="-l *#$1";
		local bchopts="-C 3 p/$1";
		local clropts=never;
	}
	local agitd="$AMI_GITD/.git"
	[ -d "$agitd" ] && {
		local cb="git branch -v --color=always";
		local gr="grep $bchopts";
		local cs="git status -s";
		local ct="git tag $tagopts";
		echo "# $AMI_PROG status git -> $cb | "$gr;
		echo "...";
		GIT_DIR="$agitd" GIT_WORK_TREE="$AMI_GITD" $cb | $gr;
		echo "...";
		echo "# $AMI_PROG status git -> $cs";
		GIT_DIR="$agitd" GIT_WORK_TREE="$AMI_GITD" $cs;
		echo "# $AMI_PROG status git -> $ct";
		GIT_DIR="$agitd" GIT_WORK_TREE="$AMI_GITD" $ct;
	}
}

function status_aur() {
	local d="$AMI_AURD"
	local p=${1:-*}
	[ -d "$d" ] && {
		echo "# $AMI_PROG status aur $p";
		cd $d && {
			for dir in $p; do
				# sorting by time may not be THAT reliable; BUT close eenuf
				ls -t1 $dir/*.tar.gz 2>/dev/null | head -n 1 ;
			done
		} | sed 's,^[^/]*/\(.*\)\.tar\.gz,\1,g'
	}
}

# main()
case $1 in
	-h)
			echo "# '$AMI_PROG status git' is default"
			echo "Usage: $AMI_PROG status [ami|aur [pkg]|git [pkg]|svn [pkg]|all]" ;;
	all)
			shift
			status_ami
			status_aur $*
			status_git $*
			status_svn $*
			;;
	ami)
			status_ami ;;
	svn)
			shift
			status_svn $* ;;
	git)
			shift
			status_git $* ;;
	aur)
			shift
			status_aur $* ;;
	*)
			status_git ;;
esac
